#!/bin/bash
# Pre-push hook - –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –ø—É—à–µ–º
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π: ./scripts/install-hooks.sh
#
# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
#   SKIP_CHECK=1  - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë
#   SKIP_FORMAT=1 - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
#   SKIP_TIDY=1   - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å clang-tidy

set -e

if [ "$SKIP_CHECK" = "1" ]; then
    echo "‚ö†Ô∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞ (SKIP_CHECK=1)"
    exit 0
fi

PROJECT_DIR="$(git rev-parse --show-toplevel)"

echo "üîç –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –ø—É—à–µ–º..."
echo ""

# ============== 1. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ==============
if [ "$SKIP_FORMAT" != "1" ]; then
    echo "[1/4] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∞–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ..."
    if command -v clang-format &> /dev/null; then
        FORMATTED=0
        for FILE in $(find "$PROJECT_DIR/src" "$PROJECT_DIR/include" "$PROJECT_DIR/tests" -name "*.cpp" -o -name "*.hpp" 2>/dev/null); do
            if ! clang-format --dry-run --Werror "$FILE" 2>/dev/null; then
                clang-format -i "$FILE"
                echo "  ‚úì –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω: $(basename "$FILE")"
                FORMATTED=1
            fi
        done
        
        if [ $FORMATTED -eq 1 ]; then
            echo ""
            echo "üìù –§–∞–π–ª—ã –±—ã–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω—ã."
            echo "   –°–æ–∑–¥–∞—ë–º –∫–æ–º–º–∏—Ç —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏..."
            git add -A
            git commit -m "style: auto-format code" --no-verify
            echo "‚úì –ö–æ–º–º–∏—Ç —Å–æ–∑–¥–∞–Ω"
        else
            echo "‚úì –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø–æ—Ä—è–¥–∫–µ"
        fi
    else
        echo "‚ö†Ô∏è  clang-format –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
    fi
else
    echo "[1/4] –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ"
fi

# ============== 2. Clang-Tidy ==============
if [ "$SKIP_TIDY" != "1" ]; then
    echo "[2/4] –ó–∞–ø—É—Å–∫ clang-tidy..."
    if command -v clang-tidy &> /dev/null; then
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º/—Å–æ–∑–¥–∞—ë–º compile_commands.json
        if [ ! -f "$PROJECT_DIR/build/compile_commands.json" ]; then
            cmake -B "$PROJECT_DIR/build" -DCMAKE_EXPORT_COMPILE_COMMANDS=ON "$PROJECT_DIR" > /dev/null 2>&1 || true
        fi
        
        if [ -f "$PROJECT_DIR/build/compile_commands.json" ]; then
            ERRORS=0
            for FILE in $(find "$PROJECT_DIR/src" "$PROJECT_DIR/include" -name "*.cpp" 2>/dev/null); do
                OUTPUT=$(clang-tidy -p "$PROJECT_DIR/build" "$FILE" 2>&1 || true)
                REAL_ERRORS=$(echo "$OUTPUT" | grep "error:" | grep -v "file not found" | grep -v "could not find" || true)
                if [ -n "$REAL_ERRORS" ]; then
                    echo "  ‚ùå $FILE"
                    echo "$REAL_ERRORS" | head -3 | sed 's/^/     /'
                    ERRORS=1
                fi
            done
            
            if [ $ERRORS -eq 1 ]; then
                echo ""
                echo "‚ùå clang-tidy –æ–±–Ω–∞—Ä—É–∂–∏–ª –æ—à–∏–±–∫–∏"
                echo "   –ò–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ: SKIP_TIDY=1 git push"
                exit 1
            fi
            echo "‚úì clang-tidy: –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
        else
            echo "‚ö†Ô∏è  compile_commands.json –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º clang-tidy"
        fi
    else
        echo "‚ö†Ô∏è  clang-tidy –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
    fi
else
    echo "[2/4] clang-tidy –ø—Ä–æ–ø—É—â–µ–Ω"
fi

# ============== 3. –°–±–æ—Ä–∫–∞ ==============
echo "[3/4] –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
BUILD_DIR="$PROJECT_DIR/build-check"
rm -rf "$BUILD_DIR"
mkdir -p "$BUILD_DIR"

cmake -B "$BUILD_DIR" -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTING=ON "$PROJECT_DIR" > /dev/null 2>&1
if ! cmake --build "$BUILD_DIR" --parallel 2>&1 | tail -5; then
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏"
    rm -rf "$BUILD_DIR"
    exit 1
fi
echo "‚úì –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞"

# ============== 4. –¢–µ—Å—Ç—ã ==============
echo "[4/4] –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
cd "$BUILD_DIR"
if ! ctest --output-on-failure 2>&1 | tail -10; then
    echo ""
    echo "‚ùå –¢–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏"
    cd "$PROJECT_DIR"
    rm -rf "$BUILD_DIR"
    exit 1
fi
cd "$PROJECT_DIR"
rm -rf "$BUILD_DIR"

echo ""
echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã! –ü—É—à —Ä–∞–∑—Ä–µ—à—ë–Ω."
exit 0
