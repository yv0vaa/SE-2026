#!/bin/bash
# Pre-commit hook –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ –∏ –∑–∞–ø—É—Å–∫–∞ clang-tidy
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π: ./scripts/install-hooks.sh
#
# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
#   SKIP_FORMAT=1  - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
#   SKIP_TIDY=1    - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å clang-tidy

set -e

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ staged —Ñ–∞–π–ª–æ–≤ C++
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|hpp|h|cc|cxx)$' || true)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# ============== –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ==============
if [ "$SKIP_FORMAT" != "1" ]; then
    if command -v clang-format &> /dev/null; then
        FORMATTED=0
        for FILE in $STAGED_FILES; do
            if [ -f "$FILE" ]; then
                clang-format -i "$FILE"
                git add "$FILE"
                FORMATTED=$((FORMATTED + 1))
            fi
        done
        
        if [ $FORMATTED -gt 0 ]; then
            echo "‚úì clang-format: –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: $FORMATTED"
        fi
    else
        echo "‚ö†Ô∏è  clang-format –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
    fi
fi

# ============== Clang-Tidy ==============
if [ "$SKIP_TIDY" != "1" ]; then
    if ! command -v clang-tidy &> /dev/null; then
        echo "‚ö†Ô∏è  clang-tidy –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑"
    else
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ compile_commands.json
        if [ ! -f "build/compile_commands.json" ]; then
            echo "‚ö†Ô∏è  build/compile_commands.json –Ω–µ –Ω–∞–π–¥–µ–Ω, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º..."
            cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON > /dev/null 2>&1 || {
                echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å compile_commands.json, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º clang-tidy"
                exit 0
            }
        fi
        
        echo "üîç –ó–∞–ø—É—Å–∫ clang-tidy..."
        ERRORS=0
        for FILE in $STAGED_FILES; do
            if [ -f "$FILE" ]; then
                OUTPUT=$(clang-tidy -p build "$FILE" 2>&1 || true)
                if echo "$OUTPUT" | grep -q "error:"; then
                    echo "‚ùå $FILE"
                    echo "$OUTPUT" | grep -E "(error:|warning:)" | head -5
                    ERRORS=1
                fi
            fi
        done
        
        if [ $ERRORS -eq 1 ]; then
            echo ""
            echo "‚ùå clang-tidy –æ–±–Ω–∞—Ä—É–∂–∏–ª –æ—à–∏–±–∫–∏. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –∏—Ö –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º."
            echo "   –ò–ª–∏ –∑–∞–∫–æ–º–º–∏—Ç—å—Ç–µ —Å: git commit --no-verify"
            echo "   –ò–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ tidy: SKIP_TIDY=1 git commit -m '...'"
            exit 1
        fi
        
        echo "‚úì clang-tidy: –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
    fi
fi

exit 0
